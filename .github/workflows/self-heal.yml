name: Self-Healing CI

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  auto-fix:
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      !startsWith(github.event.workflow_run.head_branch, 'claude/auto-fix-')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout failing commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Auto-fix with Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          max_turns: 15
          prompt: |
            The CI workflow failed on commit ${{ github.event.workflow_run.head_sha }}
            (branch: ${{ github.event.workflow_run.head_branch }}).

            1. Reproduce the failure by running the exact CI commands:
               - node --check bin/kalos.mjs
               - node bin/kalos.mjs --version
               - node bin/kalos.mjs --help
               - node bin/kalos.mjs unknown-command (should exit non-zero)

            2. Diagnose the root cause from the error output.

            3. Make the MINIMAL fix â€” change as few lines as possible.
               Do NOT refactor, reorganize, or add features.

            4. Re-run all four commands above to verify the fix passes.

            5. Commit the fix to a new branch named claude/auto-fix-${{ github.event.workflow_run.id }}
               and push it.

            6. Open a pull request targeting the ${{ github.event.workflow_run.head_branch }} branch.
               Title: "fix: auto-heal CI failure from run ${{ github.event.workflow_run.id }}"
               Body should include what broke and what was changed.
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
